<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flugdaten Formular mit KI</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; }
    input, select {
      width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box;
    }
    button {
      margin-top: 20px; padding: 10px; width: 100%;
      background-color: #007bff; color: white;
      border: none; font-size: 16px; border-radius: 5px;
    }
    img { margin-top: 10px; max-width: 100%; height: auto; }
  </style>
</head>
<body>
  <h2>Flugdaten / Flight Details</h2>

  <!-- Vorname & Nachname ganz oben -->
  <form id="flugForm">
    <label>Vorname / First Name:
      <input type="text" id="vorname" required />
    </label>
    <label>Nachname / Last Name:
      <input type="text" id="nachname" required />
    </label>

    <label>ðŸ“· Flugticket Bild hochladen / Upload ticket image:
      <input type="file" accept="image/*" onchange="verarbeiteBild(event)">
    </label>
    <img id="preview" style="display:none" />

    <!-- Automatisch befÃ¼llte, nicht bearbeitbare Felder -->
    <label>Flugtyp / Flight type:
      <select id="flugtyp" disabled>
        <option value="Flug nach Hause">Flug nach Hause</option>
        <option value="Flug nach Arbeit">Flug nach Arbeit</option>
      </select>
    </label>
    <label>Datum / Date:
      <input type="date" id="datum" readonly />
    </label>
    <label>Abflug / Departure:
      <input type="time" id="abflug" readonly />
    </label>
    <label>Ankunft / Arrival:
      <input type="time" id="ankunft" readonly />
    </label>

    <button type="button" onclick="sendeMail()">ðŸ“§ E-Mail senden</button>
  </form>

  <script>
    const deutscheStadtCodes = ["FRA", "BER", "MUC", "HAM", "STR", "DUS", "CGN", "NUE", "HAJ", "LEJ"];

   function verarbeiteBild(event) {
  const file = event.target.files[0];
  if (!file) return;

  const img = document.getElementById('preview');
  img.src = URL.createObjectURL(file);
  img.style.display = "block";

  img.onload = () => {
    Tesseract.recognize(img, 'eng', { logger: m => console.log(m) })
      .then(({ data: { text } }) => {
        console.log("OCR Ergebnis:", text);

        // Datum extrahieren
        const datumMatch = text.match(/(\d{1,2}\.\s?\w+\s?20\d{2})/); // z.â€¯B. 30. Aug 2025
        if (datumMatch) {
          const parsedDate = new Date(datumMatch[1]);
          if (!isNaN(parsedDate)) {
            document.getElementById('datum').value = parsedDate.toISOString().split('T')[0];
          }
        }

        // Abflugzeit
        const abflugMatch = text.match(/Scheduled\s+(\d{1,2}:\d{2})/);
        if (abflugMatch) document.getElementById('abflug').value = abflugMatch[1];

        // Ankunftzeit: zweite Uhrzeit
        const zeiten = [...text.matchAll(/(\d{1,2}:\d{2})/g)].map(m => m[1]);
        if (zeiten.length >= 2) document.getElementById('ankunft').value = zeiten[1];

        // Flugtyp automatisch erkennen
        const deutscheStadtCodes = ["FRA", "BER", "MUC", "HAM", "STR", "DUS", "CGN", "NUE", "HAJ", "LEJ"];
        const allCodes = [...text.matchAll(/\b[A-Z]{3}\b/g)].map(m => m[0]);
        const ziel = allCodes[1] || "";
        const isArbeit = deutscheStadtCodes.includes(ziel);
        const flugtypElem = document.getElementById('flugtyp');
        flugtypElem.value = isArbeit ? "Flug nach Arbeit" : "Flug nach Hause";
      })
      .catch(err => {
        console.error("Fehler bei der OCR:", err);
        alert("Die Flugdaten konnten nicht erkannt werden. Bitte anderes Bild versuchen.");
      });
  };
}

    function sendeMail() {
      const vorname = document.getElementById("vorname").value;
      const nachname = document.getElementById("nachname").value;
      const flugtyp = document.getElementById("flugtyp").value;
      const datum = document.getElementById("datum").value;
      const abflug = document.getElementById("abflug").value;
      const ankunft = document.getElementById("ankunft").value;

      const empfaenger = "anwar.abosaad@diebel-spedition.de";
      const betreff = "Flugdaten";
      const text = `Hallo,\n\nanbei ist mein Flug:\n\nVorname / First Name: ${vorname}\nNachname / Last Name: ${nachname}\nFlugtyp / Flight type: ${flugtyp}\nDatum / Date: ${datum}\nAbflug / Departure: ${abflug}\nAnkunft / Arrival: ${ankunft}\n\nViele GrÃ¼ÃŸe`;

      const mailtoLink = `mailto:${empfaenger}?subject=${encodeURIComponent(betreff)}&body=${encodeURIComponent(text)}`;
      window.lo
