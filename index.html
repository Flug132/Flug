<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Flugdaten Formular</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select {
      width: 100%; padding: 8px; margin-top: 4px;
      box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc;
    }
    input[readonly] { background-color: #f0f0f0; color: #555; }
    button {
      margin-top: 20px; padding: 10px; width: 100%;
      background-color: #007bff; color: white;
      border: none; font-size: 16px; border-radius: 5px;
    }
    #preview { margin-top: 10px; max-width: 100%; height: auto; }
    .header {
      display: flex; justify-content: space-between; align-items: center;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>Flugdaten Formular</h2>
    <img src="Diebel Flug1.png" alt="Logo" style="height: 50px;" />
  </div>

  <form id="flugForm">
    <label for="vorname">Vorname / First Name:
      <input type="text" id="vorname" required />
    </label>
    <label for="nachname">Nachname / Last Name:
      <input type="text" id="nachname" required />
    </label>

    <label>Flugticket hochladen / Upload flight ticket (Bild):
      <input type="file" id="bildInput" accept="image/*" />
    </label>
    <img id="preview" />

    <label>Flugtyp / Flight type:
      <input type="text" id="flugtyp" readonly />
    </label>
    <label>Datum / Date:
      <input type="date" id="datum" readonly />
    </label>
    <label>Abflug / Departure:
      <input type="time" id="abflug" readonly />
    </label>
    <label>Ankunft / Arrival:
      <input type="time" id="ankunft" readonly />
    </label>

    <button type="button" onclick="sendeMail()">ðŸ“§ E-Mail senden / Send E-Mail</button>
  </form>

  <script>
    document.getElementById("bildInput").addEventListener("change", async function () {
      const file = this.files[0];
      if (!file) return;

      const img = document.getElementById("preview");
      img.src = URL.createObjectURL(file);

      const result = await Tesseract.recognize(file, "eng+deu", { logger: m => console.log(m) });
      const text = result.data.text;
      console.log("OCR-Text:", text);

      const fromMatch = text.match(/From\s+([A-ZÃ„Ã–Ãœa-zÃ¤Ã¶Ã¼ ]+)/i);
      const toMatch = text.match(/To\s+([A-ZÃ„Ã–Ãœa-zÃ¤Ã¶Ã¼ ]+)/i);
      const dateMatch = text.match(/\b\d{2}[A-Z]{3}\d{2,4}\b/i);
      const depMatch = text.match(/\b\d{2}[:.]\d{2}\b/g);

      const toCity = toMatch?.[1]?.trim() || "";
      const deutscheStÃ¤dte = ["Berlin", "Hamburg", "MÃ¼nchen", "Stuttgart", "Frankfurt", "Leipzig", "KÃ¶ln", "DÃ¼sseldorf"];
      const flugtyp = deutscheStÃ¤dte.some(stadt => toCity.toLowerCase().includes(stadt.toLowerCase())) ? "Flug nach Arbeit" : "Flug nach Hause";
      document.getElementById("flugtyp").value = flugtyp;

      if (dateMatch) {
        let d = dateMatch[0].toUpperCase(); // z.â€¯B. 01AUG25
        const monate = {
          JAN: "01", FEB: "02", MAR: "03", APR: "04", MAY: "05", JUN: "06",
          JUL: "07", AUG: "08", SEP: "09", OCT: "10", NOV: "11", DEC: "12"
        };
        const tag = d.slice(0, 2);
        const monatText = d.slice(2, 5);
        let jahr = d.slice(5);
        if (jahr.length === 2) jahr = "20" + jahr;
        if (monate[monatText]) {
          const monat = monate[monatText];
          document.getElementById("datum").value = `${jahr}-${monat}-${tag}`;
        }
      }

      if (depMatch && depMatch.length >= 2) {
        document.getElementById("abflug").value = depMatch[0].replace(".", ":");
        document.getElementById("ankunft").value = depMatch[1].replace(".", ":");
      }
    });

    function sendeMail() {
      const empfaenger = "flugplanung@firma.de";
      const betreff = "Flug";
      const name = document.getElementById("vorname").value;
      const nachname = document.getElementById("nachname").value;
      const flugtyp = document.getElementById("flugtyp").value;
      const datum = document.getElementById("datum").value;
      const abflug = document.getElementById("abflug").value;
      const ankunft = document.getElementById("ankunft").value;

      const body = `Hallo,

anbei ist mein Flug:

Vorname / First Name: ${name}
Nachname / Last Name: ${nachname}
Flugtyp / Flight Type: ${flugtyp}
Datum / Date: ${datum}
Abflug / Departure: ${abflug}
Ankunft / Arrival: ${ankunft}

Viele GrÃ¼ÃŸe`;

      const mailtoLink = `mailto:${empfaenger}?subject=${encodeURIComponent(betreff)}&body=${encodeURIComponent(body)}`;
      window.location.href = mailtoLink;
    }
  </script>
</body>
</html>
