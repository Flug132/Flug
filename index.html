<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Flugdaten Formular</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label {
      display: block;
      margin-top: 12px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      box-sizing: border-box;
      font-size: 16px;
    }
    input[readonly], select[disabled] {
      background-color: #f0f0f0;
      color: #333;
    }
    button {
      margin-top: 20px;
      padding: 10px;
      width: 100%;
      background-color: #007bff;
      color: white;
      border: none;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
    }
    img#preview {
      max-width: 100%;
      margin-top: 10px;
      border: 1px solid #ccc;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h2 {
      margin: 0;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="header">
    <h2>Flugdaten Formular</h2>
    <img src="Diebel Flug1.png" alt="Logo" style="height: 50px;" />
  </div>

  <form id="flugForm">
    <label>Vorname / First Name:
      <input type="text" id="vorname" required />
    </label>
    <label>Nachname / Last Name:
      <input type="text" id="nachname" required />
    </label>

    <label>Flugticket / Flight Ticket (Bild hochladen):
      <input type="file" id="bildInput" accept="image/*" required />
    </label>
    <img id="preview" src="" alt="Bildvorschau" />

    <label>Flugtyp / Flight Type:
      <input type="text" id="flugtyp" readonly />
    </label>
    <label>Datum / Date:
      <input type="date" id="datum" readonly />
    </label>
    <label>Abflug / Departure:
      <input type="time" id="abflug" readonly />
    </label>
    <label>Ankunft / Arrival:
      <input type="time" id="ankunft" readonly />
    </label>

    <button type="button" onclick="sendeMail()">ðŸ“§ E-Mail senden</button>
  </form>

  <script>
    document.getElementById("bildInput").addEventListener("change", async function () {
      const file = this.files[0];
      if (!file) return;

      const img = document.getElementById("preview");
      img.src = URL.createObjectURL(file);

      const result = await Tesseract.recognize(file, "eng+deu", { logger: m => console.log(m) });
      const text = result.data.text;
      console.log("OCR TEXT:", text);

      // Flugtyp erkennen
      const fromMatch = text.match(/From\s+([A-ZÃ„Ã–Ãœa-zÃ¤Ã¶Ã¼ \-]+)/i);
      const toMatch = text.match(/To\s+([A-ZÃ„Ã–Ãœa-zÃ¤Ã¶Ã¼ \-]+)/i);
      const deutscheStÃ¤dte = ["Berlin", "Hamburg", "MÃ¼nchen", "Munich", "Frankfurt", "Cologne", "KÃ¶ln", "DÃ¼sseldorf", "Leipzig", "Stuttgart"];

      let flugtyp = "";
      const fromCity = fromMatch?.[1]?.trim() || "";
      const toCity = toMatch?.[1]?.trim() || "";

      if (deutscheStÃ¤dte.some(city => toCity.toLowerCase().includes(city.toLowerCase()))) {
        flugtyp = "Flug nach Arbeit";
      } else if (deutscheStÃ¤dte.some(city => fromCity.toLowerCase().includes(city.toLowerCase()))) {
        flugtyp = "Flug nach Hause";
      } else {
        flugtyp = "Nicht erkennbar";
      }
      document.getElementById("flugtyp").value = flugtyp;

      // Datum erkennen
      const dateMatch = text.match(/\b(\d{1,2})\s?([A-Z]{3})\s?(\d{2,4})\b/i) || text.match(/\b(\d{2})([A-Z]{3})(\d{2,4})\b/i);
      if (dateMatch) {
        const tag = dateMatch[1].padStart(2, "0");
        const monatText = dateMatch[2].toUpperCase();
        let jahr = dateMatch[3];
        if (jahr.length === 2) jahr = "20" + jahr;

        const monate = {
          JAN: "01", FEB: "02", MAR: "03", APR: "04", MAY: "05", JUN: "06",
          JUL: "07", AUG: "08", SEP: "09", OCT: "10", NOV: "11", DEC: "12"
        };

        if (monate[monatText]) {
          const monat = monate[monatText];
          document.getElementById("datum").value = `${jahr}-${monat}-${tag}`;
        }
      }

      // Abflug + Ankunft erkennen
      const timeMatches = text.match(/\b\d{1,2}[:.]\d{2}\b/g);
      if (timeMatches && timeMatches.length >= 2) {
        document.getElementById("abflug").value = timeMatches[0].replace(".", ":").padStart(5, "0");
        document.getElementById("ankunft").value = timeMatches[1].replace(".", ":").padStart(5, "0");
      }
    });

    function sendeMail() {
      const empfaenger = "anwar.abosaad@diebel-spedition.de";
      const betreff = "Flugdaten";

      const text = `Hallo,

Hier sind die Flugdaten:

Vorname: ${document.getElementById("vorname").value}
Nachname: ${document.getElementById("nachname").value}
Flugtyp: ${document.getElementById("flugtyp").value}
Datum: ${document.getElementById("datum").value}
Abflug: ${document.getElementById("abflug").value}
Ankunft: ${document.getElementById("ankunft").value}

Viele GrÃ¼ÃŸe`;

      const mailtoLink = `mailto:${empfaenger}?subject=${encodeURIComponent(betreff)}&body=${encodeURIComponent(text)}`;
      window.location.href = mailtoLink;
    }
  </script>
</body>
</html>
