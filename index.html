<script>
  const deutscheFlughaefen = [
    "Berlin", "Frankfurt", "München", "Munich", "Hamburg", "Stuttgart",
    "Düsseldorf", "Köln", "Cologne", "Hannover", "Nürnberg", "Leipzig"
  ];

  document.getElementById("bildInput").addEventListener("change", async function () {
    const file = this.files[0];
    if (!file) return;

    document.getElementById("preview").src = URL.createObjectURL(file);
    const result = await Tesseract.recognize(file, 'eng+deu');
    const text = result.data.text;
    console.log("OCR Text:", text);

    // Datum z. B. 20. Sep 2025
    const dateMatch = text.match(/(\d{1,2})[.\s-]*([A-ZÄÖÜa-zäöü]{3,})[.\s-]*(\d{4})/);
    if (dateMatch) {
      const [_, tag, monatRaw, jahr] = dateMatch;
      const monate = {
        jan: "01", feb: "02", mär: "03", mar: "03", apr: "04", mai: "05", may: "05",
        jun: "06", jul: "07", aug: "08", sep: "09", okt: "10", oct: "10", nov: "11", dez: "12", dec: "12"
      };
      const monat = monate[monatRaw.toLowerCase().slice(0, 3)];
      if (monat) {
        const datum = `${jahr}-${monat}-${tag.padStart(2, '0')}`;
        document.getElementById("datum").value = datum;
      }
    }

    // Abflug- und Ankunftszeiten (erste zwei Uhrzeiten im Text)
    const zeiten = text.match(/\b\d{1,2}[:.]\d{2}\b/g);
    if (zeiten?.length >= 2) {
      document.getElementById("abflug").value = zeiten[0].replace(".", ":");
      document.getElementById("ankunft").value = zeiten[1].replace(".", ":");
    }

    // Von/Nach: Flughafencodes + Städtenamen suchen
    let from = "", to = "";
    if (/BEY/i.test(text)) from = "Beirut";
    if (/FRA/i.test(text)) to = "Frankfurt";
    if (/Beirut/i.test(text)) from = "Beirut";
    if (/Frankfurt/i.test(text)) to = "Frankfurt";

    document.getElementById("von").value = from;
    document.getElementById("nach").value = to;

    // Flugtyp bestimmen
    const flugtyp = deutscheFlughaefen.some(city => to.toLowerCase().includes(city.toLowerCase()))
      ? "Flug nach Arbeit / Flight to Work"
      : "Flug nach Hause / Flight Home";
    document.getElementById("flugtyp").value = flugtyp;
  });

  function sendeMail() {
    const empfaenger = "anwar.abosaad@diebel-spedition.de";
    const betreff = "Flugdaten";

    const text = `Hallo,

Hier sind die Flugdaten:

Vorname: ${document.getElementById("vorname").value}
Nachname: ${document.getElementById("nachname").value}
Flugtyp: ${document.getElementById("flugtyp").value}
Von: ${document.getElementById("von").value}
Nach: ${document.getElementById("nach").value}
Datum: ${document.getElementById("datum").value}
Abflug: ${document.getElementById("abflug").value}
Ankunft: ${document.getElementById("ankunft").value}

Viele Grüße`;

    const mailtoLink = `mailto:${empfaenger}?subject=${encodeURIComponent(betreff)}&body=${encodeURIComponent(text)}`;
    window.location.href = mailtoLink;
  }
</script>
